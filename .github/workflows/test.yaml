name: Test Chart

on:
  push:
    branches:
      - master
      - feat/*

jobs:
  test-chart:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Start k3s
        run: |
          cd tests/
          docker compose up -d
          for i in {1..40}; do
            if docker compose exec -T k3s kubectl get nodes >/dev/null 2>&1; then
              echo "k3s is ready"
              break
            fi
            echo "waiting for k3s..."
            sleep 5
          done

      - name: Install kubectl + skaffold
        run: |
          curl -sLO "https://dl.k8s.io/release/$(curl -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          install -m 0755 kubectl /usr/local/bin/kubectl
          curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
          install -m 0755 skaffold /usr/local/bin/skaffold

      - name: Set kubeconfig
        run: echo "KUBECONFIG=$PWD/output/kubeconfig.yaml" >> $GITHUB_ENV

      - name: Deploy DHIS2 with FS
        run: |
          cd tests/fs/
          skaffold run --status-check --wait-for-deletions

      - name: Deploy DHIS2 with MinIO
        run: |
          cd tests/minio/
          skaffold run --status-check --wait-for-deletions

      - name: Deploy DHIS2 with S3
        run: |
          echo TODO!

      - name: Verify endpoints
        env:
          ENDPOINTS: "http://dhis2.dev.im.dhis2.org/fs http://dhis2.dev.im.dhis2.org/minio"
        run: |
          for url in $ENDPOINTS; do
            echo "üîç Checking $url"
            success=false
            for i in {1..30}; do
              if curl -sf "$url" > /dev/null; then
                echo "‚úÖ $url is reachable"
                success=true
                break
              fi
              echo "waiting for $url..."
              sleep 5
            done
          
            if [ "$success" = false ]; then
              echo "‚ùå $url did not respond"
              exit 1
            fi
          done
